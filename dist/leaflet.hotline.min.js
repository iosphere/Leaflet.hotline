/*
 (c) 2017, iosphere GmbH
 Leaflet.hotline, a Leaflet plugin for drawing gradients along polylines.
 https://github.com/iosphere/Leaflet.hotline/
*/
(function(a,b){"function"==typeof define&&define.amd?define(["leaflet"],b):"object"==typeof exports?module.exports=b:b(a.L)})(this,function(c){if(c.Hotline)return c;var a=function(b){if(!(this instanceof a))return new a(b);this._canvas=b="string"==typeof b?document.getElementById(b):b,this._ctx=b.getContext("2d"),this._width=b.width,this._height=b.height,this._weight=5,this._outlineWidth=1,this._outlineColor="black",this._min=0,this._max=1,this._data=[],this.palette({0:"green",.5:"yellow",1:"red"})};a.prototype={width:function(a){return this._width=a,this},height:function(a){return this._height=a,this},weight:function(a){return this._weight=a,this},outlineWidth:function(a){return this._outlineWidth=a,this},outlineColor:function(a){return this._outlineColor=a,this},palette:function(a){var b=document.createElement("canvas"),c=b.getContext("2d"),d=c.createLinearGradient(0,0,0,256);for(var e in b.width=1,b.height=256,a)d.addColorStop(e,a[e]);return c.fillStyle=d,c.fillRect(0,0,1,256),this._palette=c.getImageData(0,0,1,256).data,this},min:function(a){return this._min=a,this},max:function(a){return this._max=a,this},data:function(a){return this._data=a,this},add:function(a){return this._data.push(a),this},draw:function(){var a=this._ctx;return a.globalCompositeOperation="source-over",a.lineCap="round",this._drawOutline(a),this._drawHotline(a),this},getRGBForValue:function(a){var b=Math.min(Math.max((a-this._min)/(this._max-this._min),0),.999),c=4*Math.floor(256*b);return[this._palette[c],this._palette[c+1],this._palette[c+2],this._palette[c+3]/255]},_drawOutline:function(a){var b,c,d,e,f,g,h;if(this._outlineWidth){a.save();const i=[this._weight,this._weight+2*this._outlineWidth],j=["source-over","source-out"],k=["white",this._outlineColor];for(let l=0;2>l;l++){for(a.strokeStyle=k[l],a.lineWidth=i[l],a.globalCompositeOperation=j[l],a.beginPath(),(b=0,d=this._data.length);b<d;b++)for(e=this._data[b],c=1,f=e.length;c<f;c++)g=e[c-1],h=e[c],a.moveTo(g.x,g.y),a.lineTo(h.x,h.y);a.stroke()}a.restore()}},_drawHotline:function(a){var b,c,d,e,f,g,h,k,l,m;for(a.save(),a.lineWidth=this._weight,(b=0,d=this._data.length);b<d;b++)for(e=this._data[b],c=1,f=e.length;c<f;c++)g=e[c-1],h=e[c],k=a.createLinearGradient(g.x,g.y,h.x,h.y),l=this.getRGBForValue(g.z),m=this.getRGBForValue(h.z),k.addColorStop(0,"rgb("+l.join(",")+")"),k.addColorStop(1,"rgb("+m.join(",")+")"),a.strokeStyle=k,a.beginPath(),a.moveTo(g.x,g.y),a.lineTo(h.x,h.y),a.stroke();a.restore()}};var b=c.Canvas.extend({_initContainer:function(){c.Canvas.prototype._initContainer.call(this),this._hotline=new a(this._container)},_update:function(){c.Canvas.prototype._update.call(this),this._hotline.width(this._container.width),this._hotline.height(this._container.height)},_updatePoly:function(a){if(this._drawing){var b=a._parts;b.length&&(this._updateOptions(a),this._hotline.data(b).draw())}},_updateOptions:function(a){null!=a.options.min&&this._hotline.min(a.options.min),null!=a.options.max&&this._hotline.max(a.options.max),null!=a.options.weight&&this._hotline.weight(a.options.weight),null!=a.options.outlineWidth&&this._hotline.outlineWidth(a.options.outlineWidth),null!=a.options.outlineColor&&this._hotline.outlineColor(a.options.outlineColor),a.options.palette&&this._hotline.palette(a.options.palette)}}),d=function(a){return c.Browser.canvas?new b(a):null},e={clipSegment:function(d,e,f,g,h){var i,j,k,l=g?this._lastCode:c.LineUtil._getBitCode(d,f),m=c.LineUtil._getBitCode(e,f);for(this._lastCode=m;;){if(!(l|m))return[d,e];if(l&m)return!1;i=l||m,j=c.LineUtil._getEdgeIntersection(d,e,i,f,h),k=c.LineUtil._getBitCode(j,f),i===l?(j.z=d.z,d=j,l=k):(j.z=e.z,e=j,m=k)}}};return c.Hotline=c.Polyline.extend({statics:{Renderer:b,renderer:d},options:{renderer:d(),min:0,max:1,palette:{0:"green",.5:"yellow",1:"red"},weight:5,outlineColor:"black",outlineWidth:1},getRGBForValue:function(a){return this._renderer._hotline.getRGBForValue(a)},_projectLatlngs:function(a,b,d){var e,f,g=a[0]instanceof c.LatLng,h=a.length;if(g){for(f=[],e=0;e<h;e++)f[e]=this._map.latLngToLayerPoint(a[e]),f[e].z=a[e].alt,d.extend(f[e]);b.push(f)}else for(e=0;e<h;e++)this._projectLatlngs(a[e],b,d)},_clipPoints:function(){if(this.options.noClip)return void(this._parts=this._rings);this._parts=[];var a,b,c,d,f,g,h,l=this._parts,m=this._renderer._bounds;for(a=0,c=0,d=this._rings.length;a<d;a++)for(h=this._rings[a],b=0,f=h.length;b<f-1;b++)(g=e.clipSegment(h[b],h[b+1],m,b,!0),!!g)&&(l[c]=l[c]||[],l[c].push(g[0]),(g[1]!==h[b+1]||b===f-2)&&(l[c].push(g[1]),c++))},_clickTolerance:function(){return this.options.weight/2+this.options.outlineWidth+(c.Browser.touch?10:0)}}),c.hotline=function(a,b){return new c.Hotline(a,b)},c});
